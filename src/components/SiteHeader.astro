---
import { getEntry, getCollection } from "astro:content";
import Logo from "@components/Logo.astro";
import ButtonLink from "@components/ButtonLink.astro";
import Icon from "@components/Icon.astro";

import type { IconName } from "@components/Icon.astro";

const navigation = await getEntry("navigation", "main");
const services = await getCollection("services");

const { theme = "normal", position = "relative" } = Astro.props;
---

<header class="site-header" data-theme={theme} data-position={position}>
  <div class="content-wrapper | cluster">
    <Logo />
    <nav class="cluster">
      {
        navigation.data.entries.map((entry) => (
          <>
            {entry.children !== undefined ? (
              <div class="popover" x-data x-popover>
                <button
                  class="nav-link"
                  x-popover:button
                  x-bind:class="$popover.isOpen ? 'active' : ''"
                >
                  <span>{entry.title}</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12.53 16.28a.75.75 0 0 1-1.06 0l-7.5-7.5a.75.75 0 0 1 1.06-1.06L12 14.69l6.97-6.97a.75.75 0 1 1 1.06 1.06l-7.5 7.5Z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
                <div
                  class="panel-wrapper"
                  x-popover:panel
                  x-anchor="$refs.button"
                >
                  {entry.title === "Services" ? (
                    <div class="panel">
                      {services
                        .sort((a, b) => a.data.order - b.data.order)
                        .map((service) => (
                          <a
                            class="panel-link with-icon"
                            href={`/services/${service.slug}`}
                          >
                            <div class="icon-wrapper">
                              <Icon
                                name={service.data.icon as IconName}
                                color="currentColor"
                                size="1em"
                              />
                            </div>
                            <div>
                              <span>{service.data.title}</span>
                              <p>{service.data.taglinePlain}</p>
                            </div>
                          </a>
                        ))}
                    </div>
                  ) : (
                    <div class="panel">
                      {entry.children?.map((childEntry) =>
                        childEntry.icon ? (
                          <a
                            class="panel-link with-icon"
                            href={childEntry.slug}
                          >
                            <div class="icon-wrapper">
                              <Icon
                                name={childEntry.icon as IconName}
                                color="currentColor"
                                size="1em"
                              />
                            </div>
                            <div>
                              <span>{childEntry.title}</span>
                              <p>{childEntry.tagline}</p>
                            </div>
                          </a>
                        ) : (
                          <a href={childEntry.slug}>{childEntry.title}</a>
                        )
                      )}
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <a class="nav-link" href={entry.slug}>
                {entry.title}
              </a>
            )}
          </>
        ))
      }
      <ButtonLink href="/contact">
        <span>Get a Quote</span><svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
        >
          <path
            d="M1.5 8.67v8.58a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3V8.67l-8.928 5.493a3 3 0 0 1-3.144 0L1.5 8.67Z"
          ></path>
          <path
            d="M22.5 6.908V6.75a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3v.158l9.714 5.978a1.5 1.5 0 0 0 1.572 0L22.5 6.908Z"
          ></path>
        </svg>
      </ButtonLink>
    </nav>
  </div>
</header>

<style>
  .site-header {
    position: absolute;
    width: 100%;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(0.5rem);
    background: color-mix(in hsl, white, transparent 30%);
    padding-block: 0.75rem;
    border-bottom: 1px solid var(--color-neutral-1);
    box-shadow: 0px 0px 6px 0px #1d25301c;

    & .content-wrapper {
      &.cluster {
        --cluster-justify: space-between;
      }
    }

    & nav {
      &.cluster {
        --cluster-space: 0.25rem;
      }

      & > :last-child {
        margin-inline-start: 1.5rem;
      }
    }

    &[data-theme="dark"] {
      background: transparent;
      backdrop-filter: blur(1px);
      box-shadow: 0 0 16px #700c2f52;
      border-bottom-color: var(--color-neutral-8);
      color: var(--color-neutral-1);

      & .nav-link {
        &:hover {
          color: var(--color-text-link-hover-dark);
        }
      }
    }
  }

  .nav-link {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: inherit;
    line-height: var(--leading-tight);
    border-radius: var(--rounded-corners-small);
    border: 0;
    outline: 0;
    cursor: pointer;
    font-weight: 400;
    background: none;
    transition: color 0.3s ease;

    & svg {
      height: 1em;
      color: var(--color-primary-4);
    }

    &:hover {
      color: var(--color-primary-5);
      /* background-color: color-mix(
        in hsl,
        var(--color-primary-1),
        transparent 60%
      ); */
    }
  }

  .panel-wrapper {
    position: absolute;
    margin-block-start: 0.5rem;
  }

  .panel {
    background: white;
    border: 1px solid var(--color-neutral-1);
    padding: var(--space-s);
    border-radius: var(--rounded-corners-small);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    color: var(--color-neutral-9);
    box-shadow: var(--shadow-light);
    min-width: 14rem;
    animation: 0.2s fade-up ease-in-out;

    & .icon-wrapper {
      place-self: center;
      color: var(--color-neutral-8);
    }

    & a {
      color: inherit;
      text-decoration: none;

      &.with-icon {
        display: flex;
        gap: 1rem;
        text-decoration: none;
        border-radius: var(--rounded-corners-small);
        padding: 0.75rem;

        &:hover {
          background: color-mix(
            in hsl,
            var(--color-neutral-2),
            transparent 85%
          );

          & :global(svg) {
            color: var(--color-primary-5);
          }
        }

        & svg {
          height: 1.5rem;
          width: 1.5rem;
        }

        & > div {
          & span {
            font-family: var(--font-heading);
          }

          & p {
            font-size: var(--step--1);
            color: var(--color-text-body);
          }
        }
      }
    }
  }
</style>
