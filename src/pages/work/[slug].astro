---
import Layout from "@layouts/Layout.astro";
import Breadcrumb from "@components/Breadcrumb.astro";
import ButtonLink from "@components/ButtonLink.astro";
import Icon from "@components/Icon.astro";
import CTA from "@components/page_sections/CTA.astro";
import { Image } from "astro:assets";
import { getCollection, getEntries } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");

  const addReferences = projects.map(async (project) => {
    const services = await getEntries(project.data.services);
    const tools = await getEntries(project.data.tools);

    return {
      services,
      tools,
      ...project,
    };
  });

  const pages = await Promise.all(addReferences);

  return pages.map((page) => {
    return {
      params: { slug: page.slug },
      props: { page },
    };
  });
}

const { page } = Astro.props;
const {
  title,
  summary,
  featuredImage,
  galleryImages,
  type,
  services,
  scope,
  url,
} = page.data;

const { Content } = await page.render();
---

<Layout headerTheme="normal">
  <main slot="content">
    <article class="grid-9 content-wrapper section-spacer">
      <header class="hero">
        <Breadcrumb
          current={title}
          parents={[{ name: "Work", slug: "work" }]}
        />
        <h1>{summary}</h1>
        {
          url && (
            <ButtonLink classes={["mt-l", "animate-up-right"]} href={url}>
              <span>Live Site</span>
              <Icon name="arrow-up-right" />
            </ButtonLink>
          )
        }
      </header>
      <dl>
        <dt><strong>Services</strong></dt>
        <dd class="cluster">
          {
            page.services.map((service) => (
              <a href={`/services/${service.slug}`}>{service.data.title}</a>
            ))
          }
        </dd>
        <dt><strong>Scope</strong></dt>
        <dd class="cluster">
          {page.data.scope.join(", ")}
        </dd>
        <dt><strong>Tools</strong></dt>
        <dd class="cluster">
          {
            page.tools.map((tool) => (
              <span aria-label={tool.data.title}>
                <Image
                  src={tool.data.logo}
                  alt={`${tool.data.title} logo.`}
                  width={24}
                  height={24}
                  format="svg"
                />
              </span>
            ))
          }
        </dd>
      </dl>
    </article>
    <div class="gallery">
      {
        galleryImages?.map((image) => (
          <Image
            src={image.src}
            alt={image.alt}
            width={1600}
            height={1140}
            format="webp"
            loading="eager"
          />
        ))
      }
    </div>
    <div class="grid-9 content-wrapper">
      <article class="rich-content | subgrid">
        <Content />
      </article>
    </div>
    <CTA />
  </main>
</Layout>

<style>
  main {
    position: relative;
  }

  .grid-9 {
    row-gap: var(--space-xl);
    grid-template-columns:
      [content-start main-start] repeat(3, 1fr) [indent-start] repeat(3, 1fr) [main-end sidebar-start] repeat(
        3,
        1fr
      )
      [sidebar-end content-end];
  }

  .section-spacer:has(.hero) {
    margin-block-start: calc(var(--section-spacer) * 1.5);
    margin-block-end: calc(var(--section-spacer) * 0.75);
  }

  .hero {
    grid-column: main-start / main-end;
    padding-inline-end: var(--space-2xl);

    & + dl {
      display: grid;
      grid-template-columns: subgrid;
      grid-column: sidebar-start / sidebar-end;
      font-size: var(--step--1);
      margin-block-start: var(--space-xl);

      & :is(dt, dd):not(:first-of-type) {
        margin-block-start: var(--space-m);
      }

      & dd {
        grid-column: span 2;

        &.cluster {
          --cluster-align: flex-start;
          column-gap: 1rem;
          row-gap: 0.5rem;
        }

        & img {
          width: 2em;
          height: 2em;
          aspect-ratio: 1;
          object-fit: contain;
        }
      }
    }
  }

  h1 {
    margin-block-start: var(--space-m);
  }

  .gallery {
    position: relative;
    display: flex;
    gap: var(--space-2xl);
    justify-content: center;
    align-items: center;
    background: var(--color-dark-gradient);
    padding-block: var(--space-2xl);
    margin-block-end: var(--section-spacer);
    overflow: hidden;

    & img {
      position: relative;
      aspect-ratio: 7/5;
      object-fit: cover;
      width: 33%;
      height: auto;
      inset: 0;
      border-radius: var(--rounded-corners);
    }

    /* Middle/featured image */
    & img:nth-child(1) {
      order: 2;
      width: 50%;
    }

    & img:nth-child(2) {
      order: 1;
      mask-image: linear-gradient(to left, black, transparent);
    }

    & img:nth-child(3) {
      order: 3;
      mask-image: linear-gradient(to right, black, transparent);
    }
  }

  .rich-content {
    margin-block-end: var(--section-spacer);
  }

  .rich-content.subgrid {
    display: grid;
    grid-template-columns: subgrid;
    grid-column: content-start / content-end;
    margin-inline: 0;
    max-width: none;
  }

  :global(.rich-content.subgrid p) {
    grid-column: content-start / main-end;
  }

  :global(.rich-content.subgrid img:nth-of-type(1)) {
    grid-column: sidebar-start / sidebar-end;
  }

  :global(.rich-content.subgrid .feature) {
    display: grid;
    grid-template-columns: subgrid;
    grid-column: 1 / span all;
    align-items: center;
  }

  :global(.rich-content.subgrid .feature img) {
    grid-column: content-start/indent-start;
  }

  :global(.rich-content.subgrid .feature div) {
    grid-column: 5 / content-end;
  }

  :global(.rich-content.subgrid .feature[data-layout="flipped"] img) {
    grid-column: sidebar-start / sidebar-end;
  }

  :global(.rich-content.subgrid .feature[data-layout="flipped"] div) {
    order: -1;
    grid-column: content-start / 6;
  }
</style>
